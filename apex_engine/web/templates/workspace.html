<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - APEX Engine</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .section-header label {
            margin: 0;
            font-weight: 500;
        }
        
        .help-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--accent);
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .help-btn:hover {
            background: var(--accent);
            color: #fff;
        }
        
        .optimize-field-btn {
            width: 26px;
            height: 20px;
            border-radius: 4px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent));
            border: none;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .optimize-field-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }
        
        .optimize-field-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .optimize-field-btn.loading {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .char-counter {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 3px;
        }
        
        .char-counter.warning { color: var(--accent-yellow); }
        .char-counter.error { color: var(--accent-red); }
        
        .seed-component {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .seed-component textarea {
            background: var(--bg-secondary);
            min-height: 60px;
            font-size: 0.85rem;
        }
        
        .seed-component.lyrics textarea {
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }
        
        .component-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            line-height: 1.3;
        }
        
        .seed-section {
            grid-row: 1 / 3;
        }
        
        .seed-section h2 {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .optimize-bar {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .optimize-bar .btn {
            flex: 1;
            font-size: 0.85rem;
            padding: 8px 12px;
        }
        
        .loading-state {
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .loading-state.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .modal-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-width: 700px;
            width: 100%;
            margin: 40px 0;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 22px;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .tag-category {
            margin-bottom: 15px;
        }
        
        .tag-category h4 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tag-chip {
            background: var(--bg-tertiary);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .tag-chip:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .guidance-section {
            margin-bottom: 15px;
        }
        
        .guidance-section h4 {
            color: var(--accent-purple);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .guidance-section p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .guidance-section ul {
            margin-left: 18px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .guidance-section li {
            margin-bottom: 4px;
        }
        
        .guidance-section code {
            background: var(--bg-tertiary);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .collapsible-toggle {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 0;
        }
        
        .collapsible-content {
            display: none;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .section-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: -5px 0 10px 0;
        }
        
        .tools-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            border-color: var(--accent);
            background: var(--bg-primary);
        }
        
        .tool-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        
        .tool-btn.primary:hover {
            filter: brightness(1.1);
        }
        
        .tool-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .tool-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .tool-btn.primary .tool-icon {
            background: rgba(255,255,255,0.2);
        }
        
        .tool-name {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .console-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }
        
        .console-panel {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .console-line {
            padding: 2px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .console-line.success { color: #4ade80; }
        .console-line.warning { color: #fbbf24; }
        .console-line.error { color: #f87171; }
        .console-line.info { color: #60a5fa; }
        .console-line.tip { color: #c084fc; }
        
        .btn-small {
            font-size: 0.75rem;
            padding: 4px 10px;
        }
        
        .score-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent));
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .score-fill.low { background: var(--accent-red); }
        .score-fill.medium { background: var(--accent-yellow); }
        .score-fill.high { background: #4ade80; }
        
        .tier-gold { color: #fbbf24; }
        .tier-platinum { color: #e5e7eb; }
        .tier-diamond { color: #60a5fa; }
        .tier-viral { color: #c084fc; }
        .tier-unknown { color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container workspace">
        <header>
            <a href="{{ url_for('index') }}" class="back-link">&larr; Projects</a>
            <div class="project-title">
                <h1>{{ project.name }}</h1>
                <span class="status-badge {{ project.status }}">{{ project.status }}</span>
            </div>
            <div class="project-info">
                <span class="genre">{{ project.genre }}</span>
                <span class="bpm">{{ project.bpm }} BPM</span>
                <span class="mood">{{ project.mood }}</span>
            </div>
        </header>
        
        <main class="workspace-grid">
            <section class="seed-section">
                <h2>
                    Seed Composition
                    <button type="button" class="help-btn" onclick="openModal('seedGuidanceModal')">?</button>
                </h2>
                
                <div class="seed-component">
                    <div class="section-header">
                        <label>Prompt / Description</label>
                        <button type="button" class="help-btn" onclick="openFieldHelp('prompt_text')">?</button>
                        <button type="button" class="optimize-field-btn" onclick="optimizeField('prompt_text')" title="Optimize with AI">AI</button>
                    </div>
                    <p class="component-hint">Texture, atmosphere, instrumentation</p>
                    <textarea id="prompt-text" rows="2" placeholder="High-fidelity production with heavy 808s, wide stereo imaging...">{{ project.prompt_text or '' }}</textarea>
                    <div class="char-counter" id="promptCounter">0 / 500 chars</div>
                </div>
                
                <div class="seed-component lyrics">
                    <div class="section-header">
                        <label>Lyrics</label>
                        <button type="button" class="help-btn" onclick="openFieldHelp('lyrics_text')">?</button>
                        <button type="button" class="optimize-field-btn" onclick="optimizeField('lyrics_text')" title="Optimize with AI">AI</button>
                    </div>
                    <p class="component-hint">Use [Verse], [Chorus] tags. Line breaks = pauses.</p>
                    <textarea id="lyrics-text" rows="6" placeholder="[Intro]
(Yeah)

[Verse 1]
Your lyrics here...">{{ project.lyrics_text or '' }}</textarea>
                    <div class="char-counter" id="lyricsCounter">0 / 1500 chars</div>
                </div>
                
                <button type="button" class="collapsible-toggle" onclick="toggleAdvanced()">
                    Show Advanced Fields
                </button>
                
                <div class="collapsible-content" id="advancedFields">
                    <div class="seed-component">
                        <div class="section-header">
                            <label>Neuropsychological Effects</label>
                            <button type="button" class="help-btn" onclick="openFieldHelp('neuro_effects')">?</button>
                            <button type="button" class="optimize-field-btn" onclick="optimizeField('neuro_effects')" title="Optimize with AI">AI</button>
                        </div>
                        <p class="component-hint">Frisson triggers, tension/release</p>
                        <textarea id="neuro-effects" rows="2" placeholder="Build tension in verse, release on chorus...">{{ project.neuro_effects or '' }}</textarea>
                        <div class="char-counter" id="neuroCounter">0 / 300 chars</div>
                    </div>
                    
                    <div class="seed-component">
                        <div class="section-header">
                            <label>Neurochemical Targets</label>
                            <button type="button" class="help-btn" onclick="openFieldHelp('neurochemical_effects')">?</button>
                            <button type="button" class="optimize-field-btn" onclick="optimizeField('neurochemical_effects')" title="Optimize with AI">AI</button>
                        </div>
                        <p class="component-hint">Syncopation, groove, dopamine hooks</p>
                        <textarea id="neurochemical-effects" rows="2" placeholder="Syncopated hi-hats for prediction error...">{{ project.neurochemical_effects or '' }}</textarea>
                        <div class="char-counter" id="neurochemCounter">0 / 300 chars</div>
                    </div>
                    
                    <div class="seed-component">
                        <div class="section-header">
                            <label>Musical Effects</label>
                            <button type="button" class="help-btn" onclick="openFieldHelp('musical_effects')">?</button>
                            <button type="button" class="optimize-field-btn" onclick="optimizeField('musical_effects')" title="Optimize with AI">AI</button>
                        </div>
                        <p class="component-hint">Production, mixing, references</p>
                        <textarea id="musical-effects" rows="2" placeholder="Half-time verse, double-time chorus...">{{ project.musical_effects or '' }}</textarea>
                        <div class="char-counter" id="musicalCounter">0 / 300 chars</div>
                    </div>
                </div>
                
                <div class="optimize-bar">
                    <button class="btn btn-secondary" onclick="magicFill()" title="Auto-generate complete song configuration">
                        Magic Fill
                    </button>
                    <button class="btn btn-secondary" id="optimizeBtn" onclick="optimizeSeed()">
                        Optimize with AI
                    </button>
                    <div class="loading-state" id="optimizeLoading">
                        <div class="loading-spinner"></div>
                        <span>Optimizing...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="saveSeed()">Save</button>
                    <button class="btn btn-primary" onclick="generateLyrics()" id="generate-btn">
                        Generate Lyrics
                    </button>
                </div>
            </section>
            
            <section class="tools-section">
                <h2>Tools</h2>
                <p class="section-hint">On-demand agent analysis powered by GPT-4o</p>
                <div class="tools-grid">
                    <button class="tool-btn" onclick="runAnalysis('rhyme')" id="tool-rhyme">
                        <span class="tool-icon">R</span>
                        <span class="tool-name">Analyze Rhymes</span>
                    </button>
                    <button class="tool-btn" onclick="runAnalysis('flow')" id="tool-flow">
                        <span class="tool-icon">F</span>
                        <span class="tool-name">Check Flow</span>
                    </button>
                    <button class="tool-btn" onclick="runAnalysis('meme')" id="tool-meme">
                        <span class="tool-icon">M</span>
                        <span class="tool-name">Quotability</span>
                    </button>
                    <button class="tool-btn" onclick="runAnalysis('trend')" id="tool-trend">
                        <span class="tool-icon">T</span>
                        <span class="tool-name">Trend Fit</span>
                    </button>
                    <button class="tool-btn primary" onclick="runAnalysis('comprehensive')" id="tool-comprehensive">
                        <span class="tool-icon">*</span>
                        <span class="tool-name">Full Analysis</span>
                    </button>
                </div>
            </section>
            
            <section class="console-section">
                <h2>Pre-Production Console</h2>
                <div class="console-panel" id="console-panel">
                    <div class="console-line info">Ready. Run an analysis tool to see results.</div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="clearConsole()">Clear</button>
            </section>
            
            <section class="scoring-section">
                <h2>Song Health Dashboard</h2>
                <div class="scores-grid" id="scores-display">
                    {% if project.iterations and project.iterations[-1].scores %}
                    {% set scores = project.iterations[-1].scores %}
                    <div class="score-card">
                        <div class="score-label">Rhyme Density</div>
                        <div class="score-value">{{ "%.2f"|format(scores.rhyme_factor|default(0)) }}</div>
                        <div class="score-bar"><div class="score-fill" style="width: {{ (scores.rhyme_factor|default(0) * 100)|int }}%"></div></div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">Flow Consistency</div>
                        <div class="score-value">{{ "%.2f"|format(scores.flow_consistency|default(0)) }}</div>
                        <div class="score-bar"><div class="score-fill" style="width: {{ (scores.flow_consistency|default(0) * 100)|int }}%"></div></div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">PVS Score</div>
                        <div class="score-value">{{ "%.2f"|format(scores.pvs_score|default(0)) }}</div>
                        <div class="score-bar"><div class="score-fill" style="width: {{ (scores.pvs_score|default(0) * 100)|int }}%"></div></div>
                    </div>
                    <div class="score-card tier">
                        <div class="score-label">Tier</div>
                        <div class="score-value tier-{{ scores.pvs_tier|default('UNKNOWN')|lower }}">{{ scores.pvs_tier|default('--') }}</div>
                    </div>
                    {% else %}
                    <p class="empty-scores">Generate or score lyrics to see metrics</p>
                    {% endif %}
                </div>
                
                <div class="recommendations" id="recommendations">
                    <h3>Recommendations</h3>
                    <ul id="recommendations-list">
                        <li>Generate lyrics to get recommendations</li>
                    </ul>
                </div>
            </section>
            
            <section class="lyrics-section" style="grid-row: auto;">
                <div class="lyrics-header">
                    <h2>Generated Lyrics</h2>
                    <div class="version-selector">
                        <select id="version-select" onchange="loadVersion(this.value)">
                            {% for iter in project.iterations %}
                            <option value="{{ iter.version }}" {% if iter.version == project.current_iteration %}selected{% endif %}>
                                v{{ iter.version }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <textarea id="lyrics-editor" placeholder="Lyrics will appear here after generation...">{% if project.iterations %}{{ project.iterations[-1].lyrics }}{% endif %}</textarea>
                <div class="lyrics-actions">
                    <button class="btn btn-secondary" onclick="scoreLyrics()">Score</button>
                    <button class="btn btn-secondary" onclick="iterateLyrics()" id="iterate-btn">
                        Iterate
                    </button>
                </div>
            </section>
            
            <section class="approval-section" style="grid-row: auto;">
                <h2>Generation</h2>
                <div class="approval-status">
                    {% if project.status == 'approved' %}
                    <div class="approved-info">
                        <p>Lyrics approved (v{{ project.approved_version }})</p>
                        <button class="btn btn-primary" onclick="showPayloadPreview()">
                            View API Payload
                        </button>
                        <button class="btn btn-success" onclick="generateAudio()">
                            Generate Song
                        </button>
                    </div>
                    {% else %}
                    <button class="btn btn-warning" onclick="previewPayload()">
                        Preview API Payload
                    </button>
                    <button class="btn btn-primary" onclick="approveLyrics()">
                        Approve & Prepare for Generation
                    </button>
                    {% endif %}
                </div>
                
                <div class="payload-preview" id="payload-preview" style="display: none;">
                    <h3>API Payload</h3>
                    <pre id="payload-content"></pre>
                    <p class="cost-estimate">Estimated Cost: $0.075</p>
                </div>
                
                {% if project.outputs %}
                <div class="outputs">
                    <h3>Generated Audio</h3>
                    {% for output in project.outputs %}
                    <div class="audio-item">
                        <span>{{ output.filename }}</span>
                        <audio controls src="{{ output.path }}"></audio>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>
        </main>
    </div>
    
    <div class="modal" id="loading-modal" style="display: none;">
        <div class="modal-content">
            <div class="spinner"></div>
            <p id="loading-message">Processing...</p>
        </div>
    </div>
    
    <div class="modal-overlay" id="seedGuidanceModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Seed Composition Guide</h3>
                <button class="modal-close" onclick="closeModal('seedGuidanceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="guidance-section">
                    <h4>Latent Diffusion Prompting</h4>
                    <p>Sonauto uses a latent diffusion model. Control is achieved through semantic embeddings, not bracketed commands.</p>
                </div>
                
                <div class="guidance-section">
                    <h4>Prompt / Description</h4>
                    <ul>
                        <li><strong>Instrumentation:</strong> "heavy 808 bass", "rolling hi-hats", "sampled jazz piano"</li>
                        <li><strong>Atmosphere:</strong> "dark", "dystopian", "wide stereo imaging"</li>
                        <li><strong>Vocal Delivery:</strong> "aggressive flow", "melodic hook"</li>
                        <li><strong>Production:</strong> "high-fidelity", "studio-quality"</li>
                    </ul>
                </div>
                
                <div class="guidance-section">
                    <h4>Lyrics Structure</h4>
                    <ul>
                        <li><code>[Intro]</code>, <code>[Verse]</code>, <code>[Chorus]</code>, <code>[Bridge]</code>, <code>[Outro]</code></li>
                        <li>Line breaks for pauses</li>
                        <li>CAPS for intensity</li>
                        <li>Ellipses <code>...</code> for dramatic pauses</li>
                    </ul>
                </div>
                
                <div class="guidance-section">
                    <h4>CFG Scale (Prompt Strength)</h4>
                    <ul>
                        <li><strong>1.5-2.0:</strong> Natural genres (pop rap, melodic, jazz rap)</li>
                        <li><strong>2.0-2.5:</strong> Balanced (trap, hip hop, boom bap)</li>
                        <li><strong>2.5-4.0:</strong> Aggressive (phonk, drill, industrial)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const projectId = "{{ project.id }}";
        
        function setupCounter(inputId, counterId, limit) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            if (!input || !counter) return;
            
            function updateCounter() {
                const len = input.value.length;
                counter.textContent = `${len} / ${limit} chars`;
                counter.classList.remove('warning', 'error');
                if (len > limit * 1.2) counter.classList.add('error');
                else if (len > limit) counter.classList.add('warning');
            }
            
            input.addEventListener('input', updateCounter);
            updateCounter();
        }
        
        setupCounter('prompt-text', 'promptCounter', 500);
        setupCounter('lyrics-text', 'lyricsCounter', 1500);
        setupCounter('neuro-effects', 'neuroCounter', 300);
        setupCounter('neurochemical-effects', 'neurochemCounter', 300);
        setupCounter('musical-effects', 'musicalCounter', 300);
        
        function toggleAdvanced() {
            const content = document.getElementById('advancedFields');
            const btn = document.querySelector('.collapsible-toggle');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'Show Advanced Fields';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Hide Advanced Fields';
            }
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => closeModal(m.id));
            }
        });
        
        async function optimizeSeed() {
            const btn = document.getElementById('optimizeBtn');
            const loading = document.getElementById('optimizeLoading');
            
            btn.style.display = 'none';
            loading.classList.add('active');
            
            const seedData = {
                prompt_text: document.getElementById('prompt-text').value,
                lyrics_text: document.getElementById('lyrics-text').value,
                neuro_effects: document.getElementById('neuro-effects').value,
                neurochemical_effects: document.getElementById('neurochemical-effects').value,
                musical_effects: document.getElementById('musical-effects').value,
                genre: "{{ project.genre }}",
                mood: "{{ project.mood }}",
                bpm: {{ project.bpm }}
            };
            
            try {
                const response = await fetch('/api/optimize-seed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(seedData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.prompt_text) document.getElementById('prompt-text').value = result.prompt_text;
                    if (result.lyrics_text) document.getElementById('lyrics-text').value = result.lyrics_text;
                    if (result.neuro_effects) document.getElementById('neuro-effects').value = result.neuro_effects;
                    if (result.neurochemical_effects) document.getElementById('neurochemical-effects').value = result.neurochemical_effects;
                    if (result.musical_effects) document.getElementById('musical-effects').value = result.musical_effects;
                    
                    document.querySelectorAll('.seed-component textarea').forEach(ta => {
                        ta.dispatchEvent(new Event('input'));
                    });
                    
                    alert('Seed optimized!');
                } else {
                    alert('Optimization failed: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Optimization failed: ' + err.message);
            } finally {
                btn.style.display = '';
                loading.classList.remove('active');
            }
        }
        
        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-modal').style.display = 'none';
        }
        
        async function saveSeed() {
            const seedText = [
                document.getElementById('prompt-text').value,
                document.getElementById('lyrics-text').value,
                document.getElementById('neuro-effects').value,
                document.getElementById('neurochemical-effects').value,
                document.getElementById('musical-effects').value
            ].filter(Boolean).join('\n\n---\n\n');
            
            await fetch(`/api/project/${projectId}/seed`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({seed_text: seedText})
            });
            alert('Seed saved!');
        }
        
        async function generateLyrics() {
            const seedText = [
                document.getElementById('prompt-text').value,
                document.getElementById('lyrics-text').value,
                document.getElementById('neuro-effects').value,
                document.getElementById('neurochemical-effects').value,
                document.getElementById('musical-effects').value
            ].filter(Boolean).join('\n\n');
            
            if (!seedText.trim()) {
                alert('Please enter some seed content first');
                return;
            }
            
            showLoading('Generating lyrics with GPT-4o...');
            
            try {
                const response = await fetch(`/api/project/${projectId}/generate-lyrics`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({seed_text: seedText})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('lyrics-editor').value = data.lyrics;
                    updateScores(data.scores);
                    addVersionOption(data.version);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        async function iterateLyrics() {
            const lyrics = document.getElementById('lyrics-editor').value;
            if (!lyrics.trim()) {
                alert('No lyrics to iterate on');
                return;
            }
            
            showLoading('Iterating lyrics with GPT-4o...');
            
            try {
                const response = await fetch(`/api/project/${projectId}/iterate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lyrics: lyrics})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('lyrics-editor').value = data.lyrics;
                    updateScores(data.scores);
                    addVersionOption(data.version);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        async function scoreLyrics() {
            const lyrics = document.getElementById('lyrics-editor').value;
            if (!lyrics.trim()) {
                alert('No lyrics to score');
                return;
            }
            
            showLoading('Analyzing lyrics...');
            
            try {
                const response = await fetch(`/api/project/${projectId}/score`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lyrics: lyrics})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateScores(data.scores);
                    updateRecommendations(data.recommendations);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        async function previewPayload() {
            const lyrics = document.getElementById('lyrics-editor').value;
            
            try {
                const response = await fetch(`/api/project/${projectId}/preview-payload`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lyrics: lyrics})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('payload-content').textContent = 
                        JSON.stringify(data.api_payload, null, 2);
                    document.getElementById('payload-preview').style.display = 'block';
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            }
        }
        
        async function approveLyrics() {
            if (!confirm('Approve these lyrics for audio generation?')) return;
            
            showLoading('Approving lyrics...');
            
            try {
                const response = await fetch(`/api/project/${projectId}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        async function generateAudio() {
            if (!confirm('Generate audio? This will use API credits ($0.075).')) return;
            
            showLoading('Generating audio with Sonauto...');
            
            try {
                const response = await fetch(`/api/project/${projectId}/generate-audio`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Audio generation initiated! ' + data.message);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateScores(scores) {
            const html = `
                <div class="score-card">
                    <div class="score-label">Rhyme Density</div>
                    <div class="score-value">${scores.rhyme_factor?.toFixed(2) || '--'}</div>
                    <div class="score-bar"><div class="score-fill" style="width: ${(scores.rhyme_factor || 0) * 100}%"></div></div>
                </div>
                <div class="score-card">
                    <div class="score-label">Flow Consistency</div>
                    <div class="score-value">${scores.flow_consistency?.toFixed(2) || '--'}</div>
                    <div class="score-bar"><div class="score-fill" style="width: ${(scores.flow_consistency || 0) * 100}%"></div></div>
                </div>
                <div class="score-card">
                    <div class="score-label">PVS Score</div>
                    <div class="score-value">${scores.pvs_score?.toFixed(2) || '--'}</div>
                    <div class="score-bar"><div class="score-fill" style="width: ${(scores.pvs_score || 0) * 100}%"></div></div>
                </div>
                <div class="score-card tier">
                    <div class="score-label">Tier</div>
                    <div class="score-value tier-${(scores.pvs_tier || 'unknown').toLowerCase()}">${scores.pvs_tier || '--'}</div>
                </div>
            `;
            document.getElementById('scores-display').innerHTML = html;
        }
        
        function updateRecommendations(recs) {
            const list = document.getElementById('recommendations-list');
            list.innerHTML = recs.map(r => `<li>${r}</li>`).join('');
        }
        
        function addVersionOption(version) {
            const select = document.getElementById('version-select');
            const option = document.createElement('option');
            option.value = version;
            option.textContent = `v${version}`;
            option.selected = true;
            select.appendChild(option);
        }
        
        async function loadVersion(version) {
            try {
                const response = await fetch(`/api/project/${projectId}`);
                const project = await response.json();
                
                const iteration = project.iterations?.find(i => i.version == version);
                if (iteration) {
                    document.getElementById('lyrics-editor').value = iteration.lyrics || '';
                    if (iteration.scores) {
                        updateScores(iteration.scores);
                    }
                }
            } catch (e) {
                console.error('Failed to load version:', e);
            }
        }
        
        function showPayloadPreview() {
            previewPayload();
        }
        
        async function runAnalysis(analysisType) {
            const lyrics = document.getElementById('lyrics-editor').value || document.getElementById('lyrics-text').value;
            if (!lyrics.trim()) {
                addConsoleLine('error', 'No lyrics to analyze. Generate or enter lyrics first.');
                return;
            }
            
            const btn = document.getElementById(`tool-${analysisType}`);
            btn.classList.add('loading');
            
            addConsoleLine('info', `Starting ${analysisType} analysis...`);
            
            try {
                let response;
                let data;
                
                if (analysisType === 'comprehensive') {
                    response = await fetch('/api/run-full-analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            project_id: projectId,
                            lyrics: lyrics
                        })
                    });
                    
                    data = await response.json();
                    
                    if (data.success) {
                        analysisContext.console_logs = data.console_logs;
                        analysisContext.metrics = data.metrics;
                        
                        data.console_logs.forEach(log => {
                            addConsoleLine(log.type, log.message);
                        });
                        
                        if (data.metrics) {
                            updateScores({
                                rhyme_factor: data.metrics.rhyme_factor,
                                flow_consistency: data.metrics.flow_consistency,
                                pvs_score: data.metrics.meme_score,
                                pvs_tier: data.metrics.rhyme_factor >= 0.8 ? 'DIAMOND' : 
                                          data.metrics.rhyme_factor >= 0.6 ? 'PLATINUM' : 
                                          data.metrics.rhyme_factor >= 0.4 ? 'GOLD' : 'UNKNOWN'
                            });
                        }
                    } else {
                        addConsoleLine('error', 'Analysis failed: ' + (data.error || 'Unknown error'));
                    }
                } else {
                    response = await fetch(`/api/project/${projectId}/analyze/${analysisType}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({lyrics: lyrics})
                    });
                    
                    data = await response.json();
                    
                    if (data.success) {
                        data.console_logs.forEach(log => {
                            addConsoleLine(log.type, log.message);
                        });
                        
                        if (data.algorithmic_scores) {
                            updateScores(data.algorithmic_scores);
                        }
                        
                        if (data.gpt_analysis && data.gpt_analysis.recommendations) {
                            updateRecommendations(data.gpt_analysis.recommendations);
                        }
                    } else {
                        addConsoleLine('error', 'Analysis failed: ' + (data.error || 'Unknown error'));
                    }
                }
            } catch (e) {
                addConsoleLine('error', 'Request failed: ' + e.message);
            } finally {
                btn.classList.remove('loading');
            }
        }
        
        function addConsoleLine(type, message) {
            const console = document.getElementById('console-panel');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            const console = document.getElementById('console-panel');
            console.innerHTML = '<div class="console-line info">Console cleared.</div>';
        }
        
        async function magicFill() {
            const concept = prompt('Enter a concept or theme for your song (e.g., "dark trap about rising from nothing"):');
            if (!concept) return;
            
            showLoading('Magic Fill generating complete song...');
            
            try {
                const response = await fetch('/api/magic-fill', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({concept: concept})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.prompt_text) document.getElementById('prompt-text').value = data.prompt_text;
                    if (data.lyrics_text) {
                        document.getElementById('lyrics-text').value = data.lyrics_text;
                        document.getElementById('lyrics-editor').value = data.lyrics_text;
                    }
                    if (data.neuro_effects) document.getElementById('neuro-effects').value = data.neuro_effects;
                    if (data.neurochemical_effects) document.getElementById('neurochemical-effects').value = data.neurochemical_effects;
                    if (data.musical_effects) document.getElementById('musical-effects').value = data.musical_effects;
                    
                    document.querySelectorAll('.seed-component textarea').forEach(ta => {
                        ta.dispatchEvent(new Event('input'));
                    });
                    
                    addConsoleLine('success', 'Magic Fill complete! All fields populated.');
                    addConsoleLine('info', `Genre: ${data.genre}, BPM: ${data.bpm}, Mood: ${data.mood}`);
                } else {
                    addConsoleLine('error', 'Magic Fill failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                addConsoleLine('error', 'Magic Fill request failed: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        let analysisContext = {
            console_logs: [],
            metrics: {}
        };
        
        const fieldToTextareaId = {
            'prompt_text': 'prompt-text',
            'lyrics_text': 'lyrics-text',
            'neuro_effects': 'neuro-effects',
            'neurochemical_effects': 'neurochemical-effects',
            'musical_effects': 'musical-effects'
        };
        
        async function runFullAnalysis() {
            const lyrics = document.getElementById('lyrics-text').value || document.getElementById('lyrics-editor').value;
            if (!lyrics.trim()) {
                addConsoleLine('warning', 'No lyrics to analyze. Enter lyrics first.');
                return false;
            }
            
            addConsoleLine('info', 'Running comprehensive agent analysis...');
            
            try {
                const response = await fetch('/api/run-full-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_id: projectId,
                        lyrics: lyrics
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    analysisContext.console_logs = data.console_logs;
                    analysisContext.metrics = data.metrics;
                    
                    data.console_logs.forEach(log => {
                        addConsoleLine(log.type, log.message);
                    });
                    
                    return true;
                } else {
                    addConsoleLine('error', 'Full analysis failed: ' + (data.error || 'Unknown error'));
                    return false;
                }
            } catch (e) {
                addConsoleLine('error', 'Analysis request failed: ' + e.message);
                return false;
            }
        }
        
        async function optimizeField(fieldName) {
            const textareaId = fieldToTextareaId[fieldName];
            if (!textareaId) {
                addConsoleLine('error', `Unknown field: ${fieldName}`);
                return;
            }
            
            const textarea = document.getElementById(textareaId);
            const currentValue = textarea.value;
            
            const btn = textarea.closest('.seed-component').querySelector('.optimize-field-btn');
            btn.classList.add('loading');
            btn.disabled = true;
            
            addConsoleLine('info', `Optimizing ${fieldName.replace('_', ' ')} with AI...`);
            
            if (analysisContext.console_logs.length === 0) {
                addConsoleLine('info', 'Running analysis first to gather context...');
                await runFullAnalysis();
            }
            
            try {
                const response = await fetch('/api/optimize-field', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_id: projectId,
                        field_name: fieldName,
                        current_value: currentValue,
                        console_logs: analysisContext.console_logs,
                        metrics: analysisContext.metrics
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.optimized_value) {
                        textarea.value = data.optimized_value;
                        textarea.dispatchEvent(new Event('input'));
                    }
                    
                    addConsoleLine('success', `${fieldName.replace('_', ' ')} optimized successfully`);
                    
                    if (data.changes_made && Array.isArray(data.changes_made)) {
                        data.changes_made.forEach(change => {
                            addConsoleLine('tip', `Change: ${change}`);
                        });
                    }
                    
                    if (data.reasoning) {
                        addConsoleLine('info', `Reasoning: ${data.reasoning}`);
                    }
                } else {
                    addConsoleLine('error', 'Optimization failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                addConsoleLine('error', 'Optimization request failed: ' + e.message);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        async function openFieldHelp(fieldName) {
            try {
                const response = await fetch(`/api/field-help/${fieldName}`);
                const data = await response.json();
                
                if (data.success && data.help) {
                    const helpText = typeof data.help === 'object' 
                        ? Object.entries(data.help).map(([k, v]) => `${k}: ${v}`).join('\n\n')
                        : data.help;
                    
                    alert(`${fieldName.replace('_', ' ').toUpperCase()} Help:\n\n${helpText}`);
                } else {
                    alert(`No help available for ${fieldName}`);
                }
            } catch (e) {
                console.error('Failed to load field help:', e);
            }
        }
    </script>
</body>
</html>
